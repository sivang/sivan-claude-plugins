---
phase: 04-report-generation
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - site-audit/skills/site-audit/references/REPORT.md
  - site-audit/skills/site-audit/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Each finding has a severity level (error/warning/info)"
    - "Report has a run metadata header with target URL, pages crawled, duration, timestamp, and page cap"
    - "Report filename follows audit-{domain}-{date}.md pattern"
    - "Table of contents appears only when report has 50+ findings"
    - "Very large reports are truncated per section with note pointing to JSONL"
  artifacts:
    - path: "site-audit/skills/site-audit/references/REPORT.md"
      provides: "Severity rules, metadata format, TOC logic, truncation rules"
      contains: "Severity Assignment"
    - path: "site-audit/skills/site-audit/SKILL.md"
      provides: "Phase 5 with metadata header, severity column, TOC logic, truncation"
      contains: "Run metadata"
  key_links:
    - from: "Phase 5 report generation"
      to: "Severity rules in REPORT.md"
      via: "@references/REPORT.md severity section"
      pattern: "severity"
    - from: "Phase 5 metadata header"
      to: "Crawl context (seed URL, page_count, timestamps)"
      via: "Values from Phase 2 and Phase 4 context"
      pattern: "target.*pages.*duration"
    - from: "Phase 5 TOC logic"
      to: "Finding count check"
      via: "Conditional TOC generation"
      pattern: "50.*findings\|table of contents"
---

<objective>
Add severity categorization, run metadata header, conditional TOC, and large report truncation to the report generation.

Purpose: Complete the report with severity-based prioritization, audit context, and handling of edge cases (large reports, many findings).

Output:
- REPORT.md updated with severity rules, metadata format, TOC logic, truncation rules
- SKILL.md Phase 5 updated with metadata header generation, severity column in tables, conditional TOC, and truncation logic
</objective>

<execution_context>
@/Users/sivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/PROJECT.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/ROADMAP.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/STATE.md

# Context decisions for this phase
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/04-report-generation/04-CONTEXT.md

# Prior plan in this phase (creates base report structure)
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/04-report-generation/04-01-PLAN.md

# Files to modify (created/updated in 04-01)
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/references/REPORT.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add severity, metadata, TOC, and truncation rules to REPORT.md</name>
  <files>site-audit/skills/site-audit/references/REPORT.md</files>
  <action>
Add four new sections to REPORT.md (after the existing sections created in 04-01).

**Section: Severity Assignment**

Fixed severity rules per finding type (not context-dependent):

| Finding Type | Severity |
|-------------|----------|
| Broken Links | error |
| Console Errors | error |
| Broken Resources | error |
| Spelling Issues | warning |
| Visual Issues | warning |

- Severity is determined entirely by finding type
- No "info" severity currently assigned (reserved for future finding types)
- Each finding type table includes a Severity column showing the value
- Summary counts table uses these rules for the breakdown

**Section: Run Metadata Header**

The report begins with a metadata block before the summary table:

```markdown
# Site Audit Report

| Field | Value |
|-------|-------|
| Target URL | https://example.com |
| Pages Crawled | 23 |
| Page Cap | 50 |
| Duration | 4m 32s |
| Generated | 2026-01-23 14:30:00 UTC |
```

Fields:
- **Target URL**: The seed URL provided by the user
- **Pages Crawled**: Number of pages actually visited (page_count from Phase 2)
- **Page Cap**: The max_pages limit (default 50)
- **Duration**: Time from crawl start to report generation (format: Xm Ys)
- **Generated**: Timestamp when report was generated (ISO 8601)

**Section: Table of Contents**

Conditional: Only generate TOC when total findings count >= 50.

Format (when included):
```markdown
## Contents

- [Summary](#summary)
- [Broken Links](#broken-links) (3)
- [Spelling Issues](#spelling-issues) (5)
- [Console Errors](#console-errors) (2)
- [Broken Resources](#broken-resources) (1)
- [Visual Issues](#visual-issues) (2)
- [Page Index](#page-index)
```

- Only include entries for finding types that have findings
- Count in parentheses shows findings in that section
- Anchor links use lowercase-hyphenated section names
- When total findings < 50, skip TOC entirely (report is short enough to scan)

**Section: Large Report Truncation**

When a single finding type section exceeds 100 rows:

- Show first 100 rows in the table
- Add a note after the table:
  ```markdown
  > Showing 100 of {N} findings. Full data: `.audit-data/findings-{type}.jsonl`
  ```
- This prevents reports from becoming unreadably large
- Raw JSONL always has complete data

Truncation thresholds:
- Per-section cap: 100 rows
- Applies independently to each finding type section
- Page index is never truncated (shows all pages with findings)
- Summary counts always show true totals (not truncated counts)

Document additions should be ~50-70 lines total.
  </action>
  <verify>
```bash
# Verify severity section exists
grep -A 8 "Severity Assignment" site-audit/skills/site-audit/references/REPORT.md

# Verify metadata format documented
grep -A 8 "Run Metadata" site-audit/skills/site-audit/references/REPORT.md

# Verify TOC logic documented
grep "50" site-audit/skills/site-audit/references/REPORT.md | grep -i "finding\|toc\|content"

# Verify truncation rules
grep "100" site-audit/skills/site-audit/references/REPORT.md | grep -i "row\|truncat\|cap"

# Verify severity mapping for all types
grep -c "error\|warning" site-audit/skills/site-audit/references/REPORT.md  # Should be 5+

# Check total line count (should be 130-200 lines after additions)
wc -l site-audit/skills/site-audit/references/REPORT.md
```
  </verify>
  <done>
REPORT.md contains severity assignment rules (fixed per finding type), run metadata header format, conditional TOC logic (50+ findings threshold), and large report truncation rules (100 rows per section cap).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add metadata, severity, TOC, and truncation to Phase 5 in SKILL.md</name>
  <files>site-audit/skills/site-audit/SKILL.md</files>
  <action>
Update the Phase 5 implementation in SKILL.md (created in 04-01) to include metadata header, severity assignment, conditional TOC, and truncation logic.

**Changes to Phase 5 section:**

1. **Add timing capture** — At the start of Phase 5, note:
   - Record the audit start time (from Phase 2 initialization) and current time
   - Calculate duration as the difference
   - Format as "Xm Ys" (e.g., "4m 32s")

2. **Add step: Generate metadata header** — Insert as the first content in the report (before summary table):
   - Build the metadata table using values from crawl context:
     - Target URL: seed URL from Phase 1
     - Pages Crawled: page_count from Phase 2
     - Page Cap: max_pages value (default 50)
     - Duration: calculated from start to report generation
     - Generated: current ISO 8601 timestamp
   - See @references/REPORT.md for exact format

3. **Add severity to findings** — When building finding type section tables:
   - Add a "Severity" column to each finding type table
   - Apply fixed severity rules:
     - Broken links, console errors, broken resources -> "error"
     - Spelling issues, visual issues -> "warning"
   - Severity is assigned by type, not by individual finding content

4. **Add conditional TOC step** — After building summary counts, before finding sections:
   - Count total findings across all types
   - If total >= 50: generate table of contents with anchor links to each section
   - If total < 50: skip TOC (report is short enough to scan)
   - See @references/REPORT.md for TOC format

5. **Add truncation logic** — When building finding type section tables:
   - If a section has more than 100 findings, only include first 100 rows
   - After the truncated table, add note: `> Showing 100 of {N} findings. Full data: \`.audit-data/findings-{type}.jsonl\``
   - Summary counts always show true totals (not affected by truncation)
   - Page index uses all findings (not affected by truncation)

6. **Update finding type table columns** — Ensure each type table has a Severity column added. Updated table formats:

   **Broken Links:** `| Page | Target URL | Error | Severity |`
   **Spelling:** `| Page | Word | Suggestion | Context | Severity |`
   **Console Errors:** `| Page | Level | Message | Severity |`
   **Broken Resources:** `| Page | Resource URL | Type | Status | Severity |`
   **Visual Issues:** `| Page | Issue | Element | Details | Severity |`

**Do not change:**
- Steps 2-3 (filename generation, JSONL reading) — already implemented in 04-01
- Step 6-7 (page index building, file writing) — already implemented in 04-01
- Any other phases (1-4)
- Existing reference annotations

The additions integrate into the existing Phase 5 flow: metadata goes before summary, severity goes into table building, TOC goes between summary and type sections, truncation goes into type section building.

Target: Phase 5 section should grow by ~30-40 lines (total ~80-110 lines).
  </action>
  <verify>
```bash
# Verify metadata header generation
grep -i "target url\|pages crawled\|duration\|generated" site-audit/skills/site-audit/SKILL.md

# Verify severity assignment logic
grep -i "severity" site-audit/skills/site-audit/SKILL.md | head -5

# Verify severity rules documented
grep "error\|warning" site-audit/skills/site-audit/SKILL.md | grep -i "broken\|spelling\|console\|visual" | head -5

# Verify TOC conditional logic
grep -i "50.*finding\|table of contents\|toc" site-audit/skills/site-audit/SKILL.md

# Verify truncation logic
grep -i "100.*row\|100.*finding\|truncat" site-audit/skills/site-audit/SKILL.md

# Verify Severity column in table formats
grep "Severity" site-audit/skills/site-audit/SKILL.md

# Check Phase 5 is complete (not placeholder)
grep "Phase 5: Report" site-audit/skills/site-audit/SKILL.md | grep -v "to be implemented"

# Check total line count (should be 400-450 lines)
wc -l site-audit/skills/site-audit/SKILL.md
```
  </verify>
  <done>
Phase 5 in SKILL.md includes: run metadata header with target URL/pages/duration/timestamp, severity column in all finding type tables with fixed type-based rules, conditional TOC for reports with 50+ findings, and per-section truncation at 100 rows with pointer to JSONL data.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **REPORT.md enhanced:**
   - Severity Assignment section with fixed rules per type
   - Run Metadata Header format with field descriptions
   - Table of Contents conditional logic (50+ threshold)
   - Large Report Truncation rules (100 row cap per section)
   - File is 130-200 lines total

2. **Phase 5 complete:**
   - Metadata header generated with crawl context values
   - Severity column in all finding type tables
   - Conditional TOC at 50+ findings threshold
   - Per-section truncation at 100 rows
   - Summary counts reflect true totals (not truncated)
   - Page index unaffected by truncation

3. **Severity correctness:**
   - Broken links -> error
   - Console errors -> error
   - Broken resources -> error
   - Spelling issues -> warning
   - Visual issues -> warning
   - Summary table shows severity breakdown

4. **Edge cases handled:**
   - Empty findings (no sections generated, summary shows zeros)
   - Under 50 findings (no TOC)
   - Over 100 findings per type (truncated with note)
   - Missing JSONL files (treated as zero findings)
</verification>

<success_criteria>
**Measurable completion:**

1. REPORT.md contains additional sections:
   - Severity rules (5 finding types mapped to error/warning)
   - Metadata format (Target URL, Pages Crawled, Page Cap, Duration, Generated)
   - TOC logic (conditional on 50+ findings, anchor links)
   - Truncation rules (100 rows per section, note with JSONL path)

2. SKILL.md Phase 5 enhanced with:
   - Duration calculation (start time to report generation)
   - Metadata table at top of report
   - Severity column in all 5 finding type tables
   - Conditional TOC generation (50+ check)
   - Truncation logic (100 row cap with overflow note)
   - True totals in summary (unaffected by truncation)

3. All three success criteria from roadmap met:
   - RPT-01: Markdown report generated at predictable path (audit-{domain}-{date}.md)
   - RPT-02: Findings grouped by type (5 sections) and by page (page index)
   - RPT-03: Each finding has severity (error/warning) based on type
</success_criteria>

<output>
After completion, create `.planning/phases/04-report-generation/04-02-SUMMARY.md` following the standard summary template.

Include:
- Frontmatter with phase, plan, subsystem, tags, tech-stack, key-files, decisions, metrics
- What Was Built section (Severity, metadata, TOC, truncation)
- Technical Decisions (fixed severity per type, 50-finding TOC threshold, 100-row truncation cap)
- Files Changed table
- Verification Results
- Phase Completion status (Phase 4 complete - all requirements met, audit plugin fully functional)
</output>
