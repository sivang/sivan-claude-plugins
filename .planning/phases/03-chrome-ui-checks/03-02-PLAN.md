---
phase: 03-chrome-ui-checks
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - site-audit/skills/site-audit/references/UI_CHECKS.md
  - site-audit/skills/site-audit/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Visual layout issues (overflows, collapsed containers) are detected on each page"
    - "JavaScript-based checks run after console/network checks in the same loop"
    - "Visual findings are written to JSONL progressively"
  artifacts:
    - path: "site-audit/skills/site-audit/references/UI_CHECKS.md"
      provides: "JavaScript snippets for visual layout checks"
      contains: "Visual Layout Checks"
    - path: "site-audit/skills/site-audit/SKILL.md"
      provides: "Visual check integration in Phase 4 loop"
      contains: "Visual layout check"
  key_links:
    - from: "Phase 4 UI check loop"
      to: "javascript_tool"
      via: "Execute visual check JavaScript"
      pattern: "javascript_tool"
    - from: "Visual check results"
      to: "findings-visual-issues.jsonl"
      via: "JSONL append"
      pattern: "findings-visual-issues\\.jsonl"
---

<objective>
Add visual layout issue detection to Phase 4 UI checks using JavaScript-based DOM inspection.

Purpose: Detect layout problems (horizontal overflow, collapsed containers) that indicate broken CSS or rendering issues.

Output:
- Visual Layout Checks section added to UI_CHECKS.md with JavaScript snippets
- Visual check step integrated into Phase 4 loop (after console/network checks)
- Runtime: findings-visual-issues.jsonl file
</objective>

<execution_context>
@/Users/sivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/PROJECT.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/ROADMAP.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/STATE.md

# Prior plan in this phase
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/03-chrome-ui-checks/03-01-PLAN.md

# Research
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/03-chrome-ui-checks/03-RESEARCH.md

# Files to modify (created in 03-01)
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/references/UI_CHECKS.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visual layout checks to UI_CHECKS.md</name>
  <files>site-audit/skills/site-audit/references/UI_CHECKS.md</files>
  <action>
Add a new section to UI_CHECKS.md (after Broken Resource Detection section).

**Section: Visual Layout Checks**

Content should include:

1. **Horizontal Overflow Detection**
   - JavaScript snippet to find elements wider than viewport:
   ```javascript
   const vw = window.innerWidth;
   Array.from(document.querySelectorAll('*')).filter(el => {
     const rect = el.getBoundingClientRect();
     return rect.width > 0 && (rect.right > vw + 5 || rect.left < -5);
   }).map(el => ({
     tag: el.tagName,
     id: el.id || '(none)',
     class: el.className || '(none)',
     width: Math.round(rect.getBoundingClientRect().width)
   }))
   ```
   - Threshold: 5px tolerance to avoid false positives from rounding

2. **Collapsed Container Detection**
   - JavaScript snippet to find containers with children but zero height/width:
   ```javascript
   Array.from(document.querySelectorAll('div, section, article, main, aside, nav'))
     .filter(el => {
       const rect = el.getBoundingClientRect();
       const hasChildren = el.children.length > 0;
       return hasChildren && (rect.height === 0 || rect.width === 0);
     })
     .map(el => ({
       tag: el.tagName,
       id: el.id || '(none)',
       class: el.className || '(none)',
       children: el.children.length,
       height: rect.height,
       width: rect.width
     }))
   ```
   - Only checks semantic containers (div, section, article, etc.)
   - Must have children to qualify (empty containers are intentional)

3. **Overlap Detection - SKIP**
   - Note that overlap detection is O(n²) and too expensive
   - Would cause false positives (dropdowns, tooltips, overlays)
   - Recommendation: Skip overlap detection for skill-based checks

4. **Combined Check Function**
   - Provide a single JavaScript snippet that combines both checks:
   ```javascript
   (function checkLayout() {
     const vw = window.innerWidth;
     const overflows = Array.from(document.querySelectorAll('*'))
       .filter(el => {
         const rect = el.getBoundingClientRect();
         return rect.width > 0 && (rect.right > vw + 5 || rect.left < -5);
       })
       .map(el => {
         const rect = el.getBoundingClientRect();
         return {
           issue: 'overflow',
           tag: el.tagName,
           id: el.id || '(none)',
           class: el.className || '(none)',
           width: Math.round(rect.width)
         };
       });

     const collapsed = Array.from(document.querySelectorAll('div, section, article, main, aside, nav'))
       .filter(el => {
         const rect = el.getBoundingClientRect();
         return el.children.length > 0 && (rect.height === 0 || rect.width === 0);
       })
       .map(el => {
         const rect = el.getBoundingClientRect();
         return {
           issue: 'collapsed',
           tag: el.tagName,
           id: el.id || '(none)',
           class: el.className || '(none)',
           children: el.children.length
         };
       });

     return { overflows, collapsed };
   })();
   ```

5. **JSONL Format**
   ```json
   {"type":"visual_issue","page":"[url]","issue":"overflow|collapsed","element":"[tag#id.class]","details":"[description]","timestamp":"[iso8601]"}
   ```

6. **Usage Notes**
   - Execute via javascript_tool after console/network checks
   - Run on same tab (already navigated to page)
   - Parse returned object (overflows array + collapsed array)
   - Write each finding to JSONL individually
   - Skip visual checks if page failed to load

Section should be ~60-80 lines with code examples and clear explanations.
  </action>
  <verify>
```bash
# Verify new section exists
grep -A 10 "Visual Layout Checks" site-audit/skills/site-audit/references/UI_CHECKS.md

# Verify JavaScript snippets present
grep -c "getBoundingClientRect\|querySelectorAll" site-audit/skills/site-audit/references/UI_CHECKS.md  # Should be 5+ occurrences

# Verify combined check function
grep "function checkLayout" site-audit/skills/site-audit/references/UI_CHECKS.md

# Verify JSONL format documented
grep "visual_issue" site-audit/skills/site-audit/references/UI_CHECKS.md

# Check updated line count (should be 180-230 lines)
wc -l site-audit/skills/site-audit/references/UI_CHECKS.md
```
  </verify>
  <done>
UI_CHECKS.md contains Visual Layout Checks section with JavaScript snippets for overflow detection, collapsed container detection, combined check function, and JSONL format specification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate visual checks into Phase 4 loop</name>
  <files>site-audit/skills/site-audit/SKILL.md</files>
  <action>
Update Phase 4 UI check loop to include visual layout detection.

**Changes needed:**

1. **Initialization section** — Add visual_issues_count counter initialization (after broken_resources_count = 0)

2. **JSONL initialization** — Add:
   ```bash
   touch .audit-data/findings-visual-issues.jsonl
   ```

3. **UI Check Loop** — Add new step 6 (after step 5 broken resource check, before state update):

   **6. Visual layout check** — Reference @references/UI_CHECKS.md for JavaScript snippets:
   - Execute combined layout check JavaScript via javascript_tool:
     ```javascript
     (function checkLayout() {
       const vw = window.innerWidth;
       const overflows = Array.from(document.querySelectorAll('*'))
         .filter(el => {
           const rect = el.getBoundingClientRect();
           return rect.width > 0 && (rect.right > vw + 5 || rect.left < -5);
         })
         .map(el => {
           const rect = el.getBoundingClientRect();
           return {
             issue: 'overflow',
             tag: el.tagName,
             id: el.id || '(none)',
             class: el.className || '(none)',
             width: Math.round(rect.width)
           };
         });
       const collapsed = Array.from(document.querySelectorAll('div, section, article, main, aside, nav'))
         .filter(el => {
           const rect = el.getBoundingClientRect();
           return el.children.length > 0 && (rect.height === 0 || rect.width === 0);
         })
         .map(el => {
           const rect = el.getBoundingClientRect();
           return {
             issue: 'collapsed',
             tag: el.tagName,
             id: el.id || '(none)',
             class: el.className || '(none)',
             children: el.children.length
           };
         });
       return { overflows, collapsed };
     })();
     ```
   - Parse result object containing overflows and collapsed arrays
   - For each overflow: extract element details, format element string as "tag#id.class"
   - For each collapsed: extract element details, format element string as "tag#id.class"
   - Write findings to JSONL:
     ```bash
     echo '{"type":"visual_issue","page":"[url]","issue":"overflow|collapsed","element":"[element_string]","details":"[details]","timestamp":"[iso8601]"}' >> .audit-data/findings-visual-issues.jsonl
     ```
   - Increment visual_issues_count

4. **State update step** — Update to include visual issues:
   ```
   UI Check [page_check_count]/[total]: [url] - [X] issues (console: [C], broken resources: [R], visual: [V])
   ```

5. **Detailed state step** — Update to include visual issues count:
   ```
   Total findings: [console_errors_count] console errors, [broken_resources_count] broken resources, [visual_issues_count] visual issues
   ```

6. **Completion section** — Update to include visual findings in report:
   - Report findings files including findings-visual-issues.jsonl
   - Total findings should include all three types

**Do not change:**
- Phase 4 structure (keep initialization, loop, completion)
- Console/network check steps (already implemented in 03-01)
- Phase 5 placeholder

The visual check integrates as step 6 in the existing loop, between broken resource check and state update.
  </action>
  <verify>
```bash
# Verify visual_issues_count initialized
grep "visual_issues_count = 0" site-audit/skills/site-audit/SKILL.md

# Verify JSONL file initialized
grep "findings-visual-issues.jsonl" site-audit/skills/site-audit/SKILL.md | grep "touch"

# Verify visual layout check step exists
grep -A 5 "Visual layout check" site-audit/skills/site-audit/SKILL.md

# Verify JavaScript execution
grep "javascript_tool\|checkLayout" site-audit/skills/site-audit/SKILL.md

# Verify state update includes visual count
grep "visual: \[V\]" site-audit/skills/site-audit/SKILL.md

# Verify detailed state includes visual issues
grep "visual_issues_count" site-audit/skills/site-audit/SKILL.md | grep -c "Total findings"

# Verify completion mentions visual findings
grep -A 5 "After completion" site-audit/skills/site-audit/SKILL.md | grep "visual"

# Check total line count (should be 280-320 lines)
wc -l site-audit/skills/site-audit/SKILL.md
```
  </verify>
  <done>
Phase 4 UI check loop includes visual layout detection step that executes JavaScript to find overflows and collapsed containers, writes findings to findings-visual-issues.jsonl, and reports visual issue counts in state updates and completion summary.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **UI_CHECKS.md updated:**
   - New "Visual Layout Checks" section added
   - JavaScript snippets for overflow detection
   - JavaScript snippets for collapsed container detection
   - Combined check function provided
   - JSONL format documented
   - File is 180-230 lines total

2. **Phase 4 enhanced:**
   - Initialization includes visual_issues_count counter
   - JSONL initialization includes findings-visual-issues.jsonl
   - UI check loop has step 6: Visual layout check
   - JavaScript execution via javascript_tool
   - Visual findings written to JSONL
   - State updates include visual issue counts
   - Completion summary includes visual findings file

3. **Integration complete:**
   - Visual check runs after console/network checks in same loop
   - Same tab reuse pattern maintained
   - Progressive JSONL writing pattern followed
   - State reporting consistent across all check types

4. **File structure:**
   - UI_CHECKS.md: 180-230 lines (added ~60-80 lines)
   - SKILL.md: 280-320 lines (added ~30-40 lines to Phase 4)
</verification>

<success_criteria>
**Measurable completion:**

1. UI_CHECKS.md enhanced with:
   - Visual Layout Checks section (60-80 lines)
   - JavaScript snippets for overflow and collapsed detection
   - Combined check function
   - JSONL format for visual_issue type
   - Usage notes for integration

2. SKILL.md Phase 4 enhanced with:
   - visual_issues_count counter initialization
   - findings-visual-issues.jsonl file creation
   - Step 6: Visual layout check using javascript_tool
   - Overflow and collapsed container detection
   - Visual findings written to JSONL
   - State updates include visual counts
   - Completion includes visual findings

3. Complete UI check flow:
   - User runs /site-audit
   - Phase 2 crawls pages via WebFetch
   - Phase 4 opens each page in Chrome
   - For each page: Navigate → Wait → Console → Network → Visual → Report
   - Three JSONL files written: console-errors, broken-resources, visual-issues
   - User sees progress with all three finding types
</success_criteria>

<output>
After completion, create `.planning/phases/03-chrome-ui-checks/03-02-SUMMARY.md` following the standard summary template.

Include:
- Frontmatter with phase, plan, subsystem, tags, tech-stack, key-files, decisions, metrics
- What Was Built section (Visual checks integration)
- Technical Decisions (overflow threshold 5px, skip overlap detection, combined function)
- Files Changed table
- Verification Results
- Phase Completion status (Phase 3 complete, ready for Phase 4 Report Generation)
</output>
