---
phase: 03-chrome-ui-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - site-audit/skills/site-audit/references/UI_CHECKS.md
  - site-audit/skills/site-audit/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Console errors are captured from each crawled page"
    - "Broken resources (images, scripts, styles, fonts) are detected via network inspection"
    - "Findings are written to JSONL files progressively"
    - "User sees progress during UI checks"
  artifacts:
    - path: "site-audit/skills/site-audit/references/UI_CHECKS.md"
      provides: "Console filtering rules and network classification"
      min_lines: 100
    - path: "site-audit/skills/site-audit/SKILL.md"
      provides: "Phase 4 UI checks initialization and loop structure"
      contains: "Phase 4: UI Checks"
      min_lines: 200
  key_links:
    - from: "SKILL.md Phase 4"
      to: "references/UI_CHECKS.md"
      via: "@references/UI_CHECKS.md reference"
      pattern: "@references/UI_CHECKS\\.md"
    - from: "Phase 4 initialization"
      to: "tabs_create_mcp"
      via: "Chrome tab creation"
      pattern: "tabs_create_mcp"
    - from: "UI check loop"
      to: "read_console_messages"
      via: "Console error capture"
      pattern: "read_console_messages"
    - from: "UI check loop"
      to: "read_network_requests"
      via: "Broken resource detection"
      pattern: "read_network_requests"
---

<objective>
Implement Chrome-based console error and broken resource detection for all crawled pages.

Purpose: Capture runtime JavaScript errors and failed resource loads that can't be detected by backend WebFetch crawl alone.

Output:
- UI_CHECKS.md reference document with console filtering and resource classification rules
- Phase 4 (UI Checks) implementation in SKILL.md covering initialization and check loop for console/network inspection
- Runtime: findings-console-errors.jsonl and findings-broken-resources.jsonl files
</objective>

<execution_context>
@/Users/sivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/PROJECT.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/ROADMAP.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/STATE.md

# Prior phase outputs
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/02-backend-crawl-content/02-02-SUMMARY.md

# Research
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/.planning/phases/03-chrome-ui-checks/03-RESEARCH.md

# Current skill and references
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/SKILL.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/references/URL_RULES.md
@/Users/sivan/VitakkaProjects/sivan-claude-plugins/site-audit/skills/site-audit/references/CHECKS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UI_CHECKS.md reference document</name>
  <files>site-audit/skills/site-audit/references/UI_CHECKS.md</files>
  <action>
Create comprehensive reference document for Chrome-based UI checks.

**Structure:**

1. **Console Error Detection**
   - Console message classification (error vs warning)
   - Filtering rules (ignore chrome-extension://, common benign errors)
   - read_console_messages parameters: `onlyErrors: true`, `clear: true`
   - JSONL format: `{"type":"console_error","page":"[url]","level":"error|warning","message":"[msg]","timestamp":"[iso8601]"}`

2. **Broken Resource Detection**
   - Network request status classification (>= 400 = error, 0 = blocked/failed)
   - Resource type detection by extension: .jpg/.png (image), .css (style), .js (script), .woff (font)
   - read_network_requests parameters: `clear: true`
   - JavaScript fallback for images: `img.naturalWidth === 0` detection snippet
   - JSONL format: `{"type":"broken_resource","page":"[url]","resource_url":"[failed_url]","resource_type":"image|script|style|font","status":"[status]","timestamp":"[iso8601]"}`

3. **Page Load Wait Strategy**
   - Navigate → wait 3 seconds → checks
   - Max 5 seconds total wait per page
   - Handle navigation errors (timeout, load failure)

**Key points from research:**
- Reuse single Chrome tab (create once, navigate for each page)
- Clear console/network state between pages (`clear: true`)
- Filter noise: chrome-extension:// patterns, favicon 404s
- Resource classification based on URL extension and content-type

Document should be ~120-150 lines with clear sections, code examples, and JSONL schemas.
  </action>
  <verify>
```bash
cat site-audit/skills/site-audit/references/UI_CHECKS.md
wc -l site-audit/skills/site-audit/references/UI_CHECKS.md  # Should be 100+ lines
grep -c "Console Error Detection\|Broken Resource Detection\|Page Load Wait" site-audit/skills/site-audit/references/UI_CHECKS.md  # Should show 3+ sections
```
  </verify>
  <done>
UI_CHECKS.md exists with console filtering rules, network classification rules, JavaScript snippets, JSONL schemas, and page load wait strategy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Phase 4 UI Checks in SKILL.md</name>
  <files>site-audit/skills/site-audit/SKILL.md</files>
  <action>
Replace the "Phase 4: UI Checks (to be implemented)" placeholder with full implementation.

**Location:** Find line ~175 with "**Phase 4: UI Checks** (to be implemented)"

**Implementation structure (following Phase 2 pattern):**

**Initialization:**
1. Reference @references/UI_CHECKS.md for console/network check rules
2. Get visited pages list from Phase 2 (visited set in context)
3. Create Chrome tab for UI checks:
   - Call tabs_context_mcp to get existing tab group
   - Call tabs_create_mcp to create one dedicated tab
   - Store tab ID for all navigations
4. Initialize JSONL files:
   ```bash
   touch .audit-data/findings-console-errors.jsonl
   touch .audit-data/findings-broken-resources.jsonl
   ```
5. Initialize counters: page_check_count = 0, console_errors_count = 0, broken_resources_count = 0
6. Display initialization summary showing pages to check, findings files
7. Ask user to confirm before starting UI checks

**UI Check Loop:**

Execute for each URL in visited pages:

1. **Progress check** — If page_check_count >= len(visited), exit loop and proceed to Phase 5

2. **Navigate** — Navigate tab to current URL using tabs_navigate_mcp

3. **Wait** — Wait 3 seconds for page load (use sleep or wait command)

4. **Console error check** — Reference @references/UI_CHECKS.md for filtering rules:
   - Call read_console_messages with `{"tabId": tab_id, "onlyErrors": true, "clear": true}`
   - Filter out chrome-extension:// messages
   - For each error: extract level, message, timestamp
   - Write to JSONL:
     ```bash
     echo '{"type":"console_error","page":"[url]","level":"error","message":"[msg]","timestamp":"[iso8601]"}' >> .audit-data/findings-console-errors.jsonl
     ```
   - Increment console_errors_count

5. **Broken resource check** — Reference @references/UI_CHECKS.md for classification:
   - Call read_network_requests with `{"tabId": tab_id, "clear": true}`
   - Filter for failed requests (status >= 400 or status == 0)
   - Classify resource type by URL extension (.jpg→image, .css→style, .js→script, .woff→font)
   - For each broken resource: extract resource_url, type, status, timestamp
   - Write to JSONL:
     ```bash
     echo '{"type":"broken_resource","page":"[url]","resource_url":"[failed_url]","resource_type":"[type]","status":"[status]","timestamp":"[iso8601]"}' >> .audit-data/findings-broken-resources.jsonl
     ```
   - Increment broken_resources_count

6. **State update** — After each page:
   ```
   UI Check [page_check_count]/[total]: [url] - [X] issues (console: [C], broken resources: [R])
   ```

7. **Detailed state** — Every 5 pages (when page_check_count % 5 == 0):
   ```
   Total findings: [console_errors_count] console errors, [broken_resources_count] broken resources
   Remaining: [remaining_count] pages
   ```

8. **Increment and loop** — Increment page_check_count, return to step 1

**After completion:**
- Report total pages checked
- Report total findings by type
- Report findings files: findings-console-errors.jsonl, findings-broken-resources.jsonl
- Proceed to Phase 5

**Notes:**
- Single tab reuse pattern (create once, navigate many times)
- Clear console/network state between pages (`clear: true`)
- Handle navigation errors (log as finding if page fails to load)
- Progressive JSONL writing (same pattern as Phase 2)
- Wait strategy: 3 seconds per page, max 5s if needed
- Reference UI_CHECKS.md for filtering and classification rules

**Keep Phase 5 placeholder intact** (don't modify Phase 5 section).

**Update Current Status section** to reflect Phase 4 implementation.

Target: Phase 4 section should be ~80-120 lines, structured similarly to Phase 2 (initialization + loop + completion).
  </action>
  <verify>
```bash
# Verify Phase 4 no longer says "to be implemented"
grep -A 5 "Phase 4: UI Checks" site-audit/skills/site-audit/SKILL.md | grep -v "to be implemented"

# Verify references UI_CHECKS.md
grep "@references/UI_CHECKS.md" site-audit/skills/site-audit/SKILL.md

# Verify Chrome tab creation
grep "tabs_create_mcp" site-audit/skills/site-audit/SKILL.md

# Verify console check
grep "read_console_messages" site-audit/skills/site-audit/SKILL.md

# Verify network check
grep "read_network_requests" site-audit/skills/site-audit/SKILL.md

# Verify JSONL initialization
grep "findings-console-errors.jsonl" site-audit/skills/site-audit/SKILL.md

# Verify loop structure present
grep -c "UI Check \[" site-audit/skills/site-audit/SKILL.md  # Should be > 0

# Verify Phase 5 still placeholder
grep "Phase 5: Report.*to be implemented" site-audit/skills/site-audit/SKILL.md

# Check total line count (should be 250-280 lines)
wc -l site-audit/skills/site-audit/SKILL.md
```
  </verify>
  <done>
Phase 4 in SKILL.md contains full UI checks implementation: initialization with Chrome tab creation and JSONL files, UI check loop with console/network inspection, state updates, and completion summary. Phase 5 placeholder remains unchanged.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Reference document exists:**
   - UI_CHECKS.md has console filtering rules
   - UI_CHECKS.md has network classification rules
   - UI_CHECKS.md has JavaScript snippets for image checking
   - UI_CHECKS.md has JSONL format examples

2. **Phase 4 implemented:**
   - SKILL.md Phase 4 section no longer placeholder
   - Initialization references @references/UI_CHECKS.md
   - Chrome tab creation via tabs_create_mcp
   - Console check via read_console_messages
   - Network check via read_network_requests
   - JSONL files initialized (console-errors, broken-resources)
   - UI check loop with progress reporting
   - Phase 5 placeholder unchanged

3. **Integration points:**
   - Phase 4 references visited set from Phase 2 context
   - Phase 4 writes to .audit-data/ directory (created in Phase 2)
   - Follows same progressive JSONL pattern as Phase 2
   - State reporting matches Phase 2 style

4. **File structure:**
   - references/UI_CHECKS.md (new, 100+ lines)
   - SKILL.md Phase 4 (80-120 lines added)
   - Total SKILL.md ~250-280 lines
</verification>

<success_criteria>
**Measurable completion:**

1. UI_CHECKS.md file exists and contains:
   - Section on console error detection with filtering rules
   - Section on broken resource detection with classification
   - Page load wait strategy (3-5 seconds)
   - JSONL format schemas for both finding types
   - At least 100 lines total

2. SKILL.md Phase 4 contains:
   - Initialization: Chrome tab creation, JSONL file setup, counter initialization
   - UI check loop: Navigate → Wait → Console check → Network check → State update
   - Completion: Report totals and proceed to Phase 5
   - References @references/UI_CHECKS.md
   - Uses read_console_messages and read_network_requests
   - Writes findings-console-errors.jsonl and findings-broken-resources.jsonl
   - Phase 5 placeholder remains intact

3. Skill is executable:
   - User can run /site-audit and reach Phase 4 after Phase 2 completes
   - Claude has clear instructions for Chrome tab management
   - Console/network filtering rules are documented and referenced
   - Progress visible to user during UI checks
</success_criteria>

<output>
After completion, create `.planning/phases/03-chrome-ui-checks/03-01-SUMMARY.md` following the standard summary template.

Include:
- Frontmatter with phase, plan, subsystem, tags, tech-stack, key-files, decisions, metrics
- What Was Built section (UI_CHECKS.md + Phase 4 implementation)
- Technical Decisions (single tab reuse, clear state pattern, filtering strategy)
- Files Changed table
- Verification Results
- Next Phase Readiness (ready for 03-02 visual layout checks)
</output>
